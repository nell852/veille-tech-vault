name: Trello Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [opened, closed]

jobs:
  update-trello:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Trello Card ID from commit message
        id: extract
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          CARD_ID=$(echo "$COMMIT_MSG" | grep -oP '\[TRELLO-\K[^\]]+')
          echo "card_id=$CARD_ID" >> $GITHUB_OUTPUT
      
      - name: Add comment to Trello card
        if: steps.extract.outputs.card_id != ''
        run: |
          curl -X POST \
            "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/actions/comments" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "text=‚úÖ Commit pushed by ${{ github.actor }}%0Aüìù ${{ github.event.head_commit.message }}%0Aüîó ${{ github.event.head_commit.url }}"
      
      - name: Move card to EN REVUE on main branch
        if: github.ref == 'refs/heads/main' && steps.extract.outputs.card_id != ''
        run: |
          curl -X PUT \
            "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "idList=${{ secrets.TRELLO_LIST_EN_REVUE }}"
      
      - name: Send Slack notification
        if: steps.extract.outputs.card_id != '' && github.ref == 'refs/heads/main'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          slack-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel-id: 'C0A1JAS4KRP'
          text: "üöÄ La carte Trello <https://trello.com/c/${{ steps.extract.outputs.card_id }}|EN REVUE> vient d'arriver sur EN REVUE !"
